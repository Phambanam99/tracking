generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model User {
  id               Int                   @id @default(autoincrement())
  email            String                @unique
  username         String                @unique
  password         String
  firstName        String?
  lastName         String?
  role             UserRole              @default(USER)
  isActive         Boolean               @default(true)
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  aircraftEdits    AircraftEditHistory[] @relation("AircraftEdits")
  regionAlerts     RegionAlert[]
  regions          Region[]
  userFilters      UserFilters[]
  sessions         UserSession[]
  trackedAircrafts UserTrackedAircraft[]
  trackedVessels   UserTrackedVessel[]
  vesselEdits      VesselEditHistory[]   @relation("VesselEdits")

  @@map("users")
}

model UserSession {
  id           String   @id @default(cuid())
  userId       Int
  accessToken  String   @unique
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@map("user_sessions")
}

model Aircraft {
  id             Int                   @id @default(autoincrement())
  flightId       String                @unique
  callSign       String?
  registration   String?
  aircraftType   String?
  operator       String?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  editHistory    AircraftEditHistory[]
  images         AircraftImage[]
  positions      AircraftPosition[]
  trackedByUsers UserTrackedAircraft[]

  @@map("aircrafts")
}

model AircraftEditHistory {
  id         Int      @id @default(autoincrement())
  aircraftId Int
  userId     Int
  changes    String
  editedAt   DateTime @default(now())
  aircraft   Aircraft @relation(fields: [aircraftId], references: [id], onDelete: Cascade)
  user       User     @relation("AircraftEdits", fields: [userId], references: [id], onDelete: Cascade)

  @@index([aircraftId])
  @@index([editedAt])
  @@map("aircraft_edit_history")
}

model AircraftPosition {
  id         Int      @id @default(autoincrement())
  aircraftId Int
  latitude   Float
  longitude  Float
  altitude   Int?
  speed      Int?
  heading    Int?
  timestamp  DateTime @default(now())
  score      Float?
  source     String?
  aircraft   Aircraft @relation(fields: [aircraftId], references: [id], onDelete: Cascade)

  @@unique([aircraftId, timestamp, source])
  @@index([aircraftId])
  @@index([timestamp])
  @@index([latitude, longitude])
  @@map("aircraft_positions")
}

model Vessel {
  id                     Int                 @id @default(autoincrement())
  mmsi                   String              @unique
  vesselName             String?
  vesselType             String?
  flag                   String?
  operator               String?
  length                 Int?
  width                  Int?
  imo                    String?
  callSign               String?
  destination            String?
  eta                    DateTime?
  draught                Float?
  yearBuilt              Int?
  grossTonnage           Int?
  deadweight             Int?
  homePort               String?
  owner                  String?
  manager                String?
  classification         String?
  enrichedAt             DateTime?
  enrichmentSource       String?
  enrichmentAttempts     Int                 @default(0)
  lastEnrichmentAttempt  DateTime?
  enrichmentError        String?
  dataQualityScore       Float?
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  trackedByUsers         UserTrackedVessel[]
  editHistory            VesselEditHistory[]
  images                 VesselImage[]
  positions              VesselPosition[]

  @@index([enrichedAt, enrichmentAttempts])
  @@map("vessels")
}

model VesselEditHistory {
  id       Int      @id @default(autoincrement())
  vesselId Int
  userId   Int
  changes  String
  editedAt DateTime @default(now())
  user     User     @relation("VesselEdits", fields: [userId], references: [id], onDelete: Cascade)
  vessel   Vessel   @relation(fields: [vesselId], references: [id], onDelete: Cascade)

  @@index([vesselId])
  @@index([editedAt])
  @@map("vessel_edit_history")
}

model UserTrackedAircraft {
  id         Int      @id @default(autoincrement())
  userId     Int
  aircraftId Int
  alias      String?
  notes      String?
  createdAt  DateTime @default(now())
  aircraft   Aircraft @relation(fields: [aircraftId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, aircraftId])
  @@map("user_tracked_aircrafts")
}

model UserTrackedVessel {
  id        Int      @id @default(autoincrement())
  userId    Int
  vesselId  Int
  alias     String?
  notes     String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vessel    Vessel   @relation(fields: [vesselId], references: [id], onDelete: Cascade)

  @@unique([userId, vesselId])
  @@map("user_tracked_vessels")
}

model VesselPosition {
  id        Int      @id @default(autoincrement())
  vesselId  Int
  latitude  Float
  longitude Float
  speed     Float?
  course    Int?
  heading   Int?
  status    String?
  timestamp DateTime @default(now())
  source    String?
  score     Float?
  vessel    Vessel   @relation(fields: [vesselId], references: [id], onDelete: Cascade)

  @@unique([vesselId, timestamp])
  @@index([vesselId])
  @@index([timestamp])
  @@index([latitude, longitude])
  @@map("vessel_positions")
}

model Region {
  id            Int                   @id @default(autoincrement())
  name          String
  description   String?
  userId        Int
  isActive      Boolean               @default(true)
  alertOnEntry  Boolean               @default(true)
  alertOnExit   Boolean               @default(true)
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  boundary      Json
  regionType    RegionType            @default(POLYGON)
  centerLat     Float?
  centerLng     Float?
  radius        Float?
  alerts        RegionAlert[]
  objectHistory RegionObjectHistory[]
  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("regions")
}

model RegionAlert {
  id         Int        @id @default(autoincrement())
  regionId   Int
  userId     Int
  objectType ObjectType
  objectId   Int
  alertType  AlertType
  latitude   Float
  longitude  Float
  isRead     Boolean    @default(false)
  createdAt  DateTime   @default(now())
  region     Region     @relation(fields: [regionId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([regionId])
  @@index([createdAt])
  @@map("region_alerts")
}

model RegionObjectHistory {
  id         Int        @id @default(autoincrement())
  regionId   Int
  objectType ObjectType
  objectId   Int
  isInside   Boolean
  enteredAt  DateTime?
  exitedAt   DateTime?
  updatedAt  DateTime   @updatedAt
  region     Region     @relation(fields: [regionId], references: [id], onDelete: Cascade)

  @@unique([regionId, objectType, objectId])
  @@index([regionId])
  @@map("region_object_history")
}

model UserFilters {
  id               Int      @id @default(autoincrement())
  userId           Int
  name             String
  activeFilterTab  String
  aircraftViewMode String
  vesselViewMode   String
  aircraft         Json
  vessel           Json
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
  @@map("user_filters")
}

model SystemSettings {
  id                     Int      @id @default(1)
  clusterEnabled         Boolean  @default(true)
  minZoom                Int      @default(4)
  maxZoom                Int      @default(16)
  signalStaleMinutes     Int      @default(10)
  vesselFlagColors       Json     @default("{}")
  aircraftOperatorColors Json     @default("{}")
  updatedAt              DateTime @updatedAt
  mapProvider            String   @default("osm")
  maptilerApiKey         String?
  maptilerStyle          String   @default("streets")

  @@map("system_settings")
}

model Port {
  id        Int      @id @default(autoincrement())
  city      String
  state     String?
  country   String?
  latitude  Float
  longitude Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([city, state, country, latitude, longitude])
  @@index([latitude, longitude])
  @@map("ports")
}

model AisVesselLatest {
  mmsi      String   @id
  latitude  Float
  longitude Float
  speed     Float?
  course    Int?
  sourceId  String?
  score     Float
  timestamp DateTime
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@index([timestamp])
  @@map("ais_vessel_latest")
}

model AisVesselHistory {
  id        Int      @id @default(autoincrement())
  mmsi      String
  latitude  Float
  longitude Float
  speed     Float?
  course    Int?
  sourceId  String?
  score     Float
  timestamp DateTime
  createdAt DateTime @default(now())

  @@index([mmsi])
  @@index([timestamp])
  @@index([mmsi, timestamp])
  @@map("ais_vessel_history")
}

model VesselImage {
  id        Int      @id @default(autoincrement())
  vesselId  Int
  url       String
  caption   String?
  source    String?
  isPrimary Boolean  @default(false)
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  vessel    Vessel   @relation(fields: [vesselId], references: [id], onDelete: Cascade)

  @@index([vesselId])
  @@map("vessel_images")
}

model AircraftImage {
  id         Int      @id @default(autoincrement())
  aircraftId Int
  url        String
  caption    String?
  source     String?
  isPrimary  Boolean  @default(false)
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  aircraft   Aircraft @relation(fields: [aircraftId], references: [id], onDelete: Cascade)

  @@index([aircraftId])
  @@map("aircraft_images")
}

model VesselEnrichmentQueue {
  id            Int      @id @default(autoincrement())
  mmsi          String
  priority      Int      @default(0)
  status        String   @default("pending")
  attempts      Int      @default(0)
  lastAttemptAt DateTime?
  error         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status, priority, createdAt])
  @@index([mmsi])
  @@map("vessel_enrichment_queue")
}

model VesselEnrichmentLog {
  id            Int      @id @default(autoincrement())
  mmsi          String
  source        String?
  success       Boolean
  fieldsUpdated String[]
  error         String?
  duration      Int?
  createdAt     DateTime @default(now())

  @@index([mmsi, createdAt])
  @@index([createdAt])
  @@map("vessel_enrichment_log")
}

enum UserRole {
  ADMIN
  OPERATOR
  USER
  VIEWER
}

enum RegionType {
  POLYGON
  CIRCLE
}

enum ObjectType {
  AIRCRAFT
  VESSEL
}

enum AlertType {
  ENTRY
  EXIT
}
